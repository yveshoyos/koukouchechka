<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Layout without menu and footer -->
    <template id="layout" inherit_id="website.layout" name="Event seating layout" primary="True">
        <xpath expr="//div[@id='wrapwrap']/header" position="replace"/>
        <xpath expr="//div[@id='wrapwrap']/footer" position="replace"/>
        <xpath expr="//t[@t-call-assets='website.assets_editor'][@t-css='false']" position="after">
            <link rel="stylesheet" href="/event_seating/static/lib/seat-charts/jquery.seat-charts.css"/>
            <link rel="stylesheet" href="/event_seating/static/src/css/seating.css"/>
            <script src="/event_seating/static/lib/seat-charts/jquery.seat-charts.js"/>
            <t t-raw='theater.get_css_seats_colors()'/>
        </xpath>
    </template>

    <template id="go_to_backend" name="Event seating go to backend">
        <div class="alert alert-info">
            <div class="container">
                <div class="text-center">
                    You can go back to backend by using following link.
                    <a t-attf-href="/web#return_label=Website&amp;model=#{model}&amp;id=#{res_id}&amp;view_type=form&amp;action=#{website.env.ref(action).id}">
                        <i class="fa fa-arrow-right"/> Back to edit mode
                    </a>
                </div>
            </div>
        </div>
    </template>

    <template id="seat_map" name="Event seating map">
        <div class="row">
            <div class="col-xs-12">
                <div id="seat-map">
                    <div class="front-indicator">Front</div>
                </div>
            </div>
        </div>
    </template>

    <!-- Page preview -->
    <template id="preview" name="Theater preview">
        <t t-call="event_seating.layout">
            <div id="wrap">
                <t t-call="event_seating.go_to_backend">
                    <t t-set="model" t-value="'event.theater'"/>
                    <t t-set="res_id" t-value="theater.id"/>
                    <t t-set="action" t-value="'event_seating.event_theater_action'"/>
                </t>
                <div class="oe_structure"/>
                <div class="container">
                    <div class="row">
                        <div class="col-xs-12">
                            <h1 t-field="theater.name"/>
                        </div>
                    </div>
                    <t t-call="event_seating.seat_map"/>
                    <div class="row">
                        <div class="col-xs-12">
                            <h2>Legend</h2>
                            <div id="legend"/>
                        </div>
                    </div>
                </div>
                <script>
                    $(document).ready(function() {
                        var seat_num = 1;
                        var sc = $('#seat-map').seatCharts({
                            map: <t t-raw="theater.get_json_disposition()"/>,
                            seats: <t t-raw="theater.get_json_seats()"/>,
                            legend: {
                                node : $('#legend'),
                                items : <t t-raw="theater.get_json_legend_items()"/>
                            },
                            naming: {
                                top : false,
                                left: true,
                                rows: <t t-raw="theater.get_rows()"/>,
                                getId: function(character, row, column) {
                                    return row + '-' + seat_num;
                                },
                                getLabel : function (character, row, column) {
                                    return row + '-' + seat_num++;
                                }
                            }
                        });
                    });
                </script>
                <div class="oe_structure"/>
            </div>
        </t>
    </template>


    <!-- Page seat selection -->
    <template id="seat_selection" name="Seat selection">
        <t t-set="theater" t-value="event.theater_id"/>
        <t t-call="event_seating.layout">
            <div id="wrap">
                <t t-call="event_seating.go_to_backend">
                    <t t-set="model" t-value="'event.event'"/>
                    <t t-set="res_id" t-value="theater.id"/>
                    <t t-set="action" t-value="'event.action_event_view'"/>
                </t>
                <div class="oe_structure"/>
                <div class="container">
                    <div class="row">
                        <div class="col-xs-12">
                            <h1>Seat selection for event "<t t-esc="event.name"/>"</h1>
                        </div>
                    </div>
                    <div class="row" t-if="not theater">
                        <div class="col-xs-12">
                            <p>You must select a theater in the event to use this function.</p>
                        </div>
                    </div>
                    <t t-call="event_seating.seat_map"/>
                    <div class="row" t-if="theater">
                        <div class="col-xs-12 col-lg-2">
                            <h2>Legend</h2>
                            <div id="legend"/>
                        </div>
                        <div class="col-xs-12 col-lg-6">
                            <h2>Attendees</h2>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Date</th>
                                        <th>Seated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="event.registration_ids" t-as="registration">
                                        <tr>
                                            <td t-esc="registration.name"/>
                                            <td t-esc="registration.date_open" t-options="{'widget': 'datetime'}"/>
                                            <td>
                                                <span t-esc="registration.seats_count"/> / <span t-esc="registration.qty"/>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-xs-12 col-lg-4">
                            <h2>Seats (<span id="seats_counter">0</span>) <a href="#" class="btn-xs unselect_all_seats">[remove all]</a></h2>
                            <div id="selected_seats"/>
                            <div id="selected_grouped_seats"/>
                        </div>
                    </div>
                    <script t-if="theater">
                        function group_seats(seats) {
                            if (jQuery.isEmptyObject(seats)) {
                                return [];
                            }
                            var number_label = {};
                            var numbers = [];
                            for (var id in seats) {
                                var label = seats[id];
                                var num = parseInt(label.replace(/\D/g, ""), 10);
                                number_label[num] = label;
                                numbers.push(num);
                            }
                            numbers = numbers.sort(function (a, b) { return a - b; });
                            var groups = [[number_label[numbers[0]]]];
                            var n = 0;
                            for (var i=1; i &lt; numbers.length; i++) {
                                if (numbers[i-1] + 1 == numbers[i]) {
                                    groups[n].push(number_label[numbers[i]]);
                                }
                                else {
                                    n++;
                                    groups[n] = [number_label[numbers[i]]];
                                }
                            }
                            return groups;
                        }
                        function html_group_seats(seats) {
                            var groups = group_seats(seats);
                            var res = [];
                            var n = 0;
                            for (var i in groups) {
                                if (groups[i].length > 1) {
                                    var first = groups[i][0];
                                    var last = groups[i].slice(-1)[0];
                                    res.push(first + ' - ' + last);
                                }
                                else if (groups[i].length == 1) {
                                    res.push(groups[i][0]);
                                }
                            }
                            return res.join('&lt;br/&gt;');
                        }
                        $(document).ready(function() {
                            var registrations = <t t-raw="event.get_registrations_json()"/>;
                            var seat_num = 1;
                            var selected_seats = [];
                            var last_selected;
                            var $counter = $('#seats_counter');
                            var $cart = $('#selected_seats');
                            var $grouped = $('#selected_grouped_seats');
                            var sc = $('#seat-map').seatCharts({
                                map: <t t-raw="theater.get_json_disposition()"/>,
                                seats: <t t-raw="theater.get_json_seats()"/>,
                                legend : {
                                    node : $('#legend'),
                                    items : <t t-raw="theater.get_json_legend_items()"/>
                                },
                                naming : {
                                    top : false,
                                    left: true,
                                    rows: <t t-raw="theater.get_rows()"/>,
                                    getId: function(character, row, column) {
                                        return row + '-' + seat_num;
                                    },
                                    getLabel : function (character, row, column) {
                                        return row + '-' + seat_num++;
                                    }
                                },
                                click: function (e) {
                                    if (last_selected &amp;&amp; e.shiftKey) {
                                    }
                                    last_selected = this;
                                    if (this.status() == 'available') {
                                        $('&lt;span class="label label-primary"/&gt;').text(this.settings.label)
                                            .attr('id', 'cart-item-' + this.settings.id)
                                            .data('seat-id', this.settings.id)
                                            .appendTo($cart);
                                        $cart.append(' ');
                                        $counter.text(sc.find('selected').length + 1);
                                        selected_seats[this.settings.id] = this.settings.label;
                                        $grouped.html(html_group_seats(selected_seats));
                                        return 'selected';
                                    }
                                    else if (this.status() == 'selected') {
                                        $counter.text(sc.find('selected').length - 1);
							            $('#cart-item-' + this.settings.id).remove();
                                        delete selected_seats[this.settings.id];
                                        $grouped.html(html_group_seats(selected_seats));
                                        return 'available';
                                    }
                                    else if (this.status() == 'unavailable') {
                                        return 'unavailable';
                                    }
                                    return this.style();
                                }
                            });
                            $('.unselect_all_seats').on('click', function () {
                                sc.find('selected').node().click();
                            });
                        });
                    </script>
                </div>
                <div class="oe_structure"/>
            </div>
        </t>
    </template>

</odoo>
